"use client";

import React, { useEffect, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { supabase } from "@/integrations/supabase/client";
import Header from "@/components/header";
import { Button } from "@/components/ui/button";
import { useLocale } from "@/contexts/LocaleContext";
import { getTranslation } from "@/lib/translations";
import { toast } from "sonner";
import { useSession } from "@/contexts/SessionContext";
import { MadeWithDyad } from "@/components/made-with-dyad";

// ----------------------------------------------------
//  KEEP YOUR EXISTING RECOMMENDATIONS + COMPETENCY_META
//  exactly as they are above this comment.
// ----------------------------------------------------

// Order of competencies
const COMPETENCY_ORDER: string[] = [
  "mental_toughness",
  "opening_conversations",
  "identifying_real_needs",
  "destroying_objections",
  "creating_irresistible_offers",
  "mastering_closing",
  "follow_up_discipline",
];

interface CompetencyResult {
  competencyId: string;
  name: string;
  nameAr?: string;
  score: number;
  maxScore: number;
  percentage: number;
  tier: "Strength" | "Opportunity" | "Threat" | "Weakness";
}

function DonutChart({
  percentage,
  size = 160,
  stroke = 18,
  color = "#6366f1",
}: {
  percentage: number;
  size?: number;
  stroke?: number;
  color?: string;
}) {
  const radius = (size - stroke) / 2;
  const circumference = 2 * Math.PI * radius;
  const offset = circumference * (1 - percentage / 100);

  return (
    <svg width={size} height={size} className="mx-auto">
      <defs>
        <linearGradient id="donutGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stopColor="#22c55e" />
          <stop offset="50%" stopColor="#3b82f6" />
          <stop offset="100%" stopColor="#ec4899" />
        </linearGradient>
      </defs>

      <circle
        cx={size / 2}
        cy={size / 2}
        r={radius}
        stroke="#e5e7eb"
        strokeWidth={stroke}
        fill="none"
      />
      <circle
        cx={size / 2}
        cy={size / 2}
        r={radius}
        stroke={color === "gradient" ? "url(#donutGradient)" : color}
        strokeWidth={stroke}
        fill="none"
        strokeDasharray={circumference}
        strokeDashoffset={offset}
        strokeLinecap="round"
        transform={`rotate(-90 ${size / 2} ${size / 2})`}
      />
      <text
        x="50%"
        y="50%"
        textAnchor="middle"
        dominantBaseline="central"
        className="text-3xl font-bold fill-slate-900"
      >
        {percentage}%
      </text>
    </svg>
  );
}

function CompetencyBars({
  results,
  language,
}: {
  results: CompetencyResult[];
  language: string;
}) {
  const ordered = COMPETENCY_ORDER
    .map((id) => results.find((r) => r.competencyId === id))
    .filter(Boolean) as CompetencyResult[];

  return (
    <div className="space-y-3">
      {ordered.map((comp) => {
        const meta = (COMPETENCY_META as any)[comp.competencyId];
        const label = language === "ar" ? meta.labelAr : meta.labelEn;
        return (
          <div key={comp.competencyId}>
            <div className="flex justify-between text-xs md:text-sm mb-1">
              <span className="font-semibold text-slate-800">{label}</span>
              <span className="font-bold text-slate-900">{comp.percentage}%</span>
            </div>
            <div className="w-full bg-slate-200 rounded-full h-2.5">
              <div
                className="h-2.5 rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"
                style={{ width: `${comp.percentage}%` }}
              />
            </div>
          </div>
        );
      })}
    </div>
  );
}

function getRecommendations(
  competencyId: string,
  tier: string,
  language: string
): string[] {
  const recs = (RECOMMENDATIONS as any)[competencyId]?.[tier];
  if (!recs) {
    return [
      language === "ar"
        ? "Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ† ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ù‡Ø§Ø±Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©."
        : "Keep improving and building on your current skills.",
    ];
  }
  return language === "ar" ? recs.ar : recs.en;
}

function getTierNameInArabic(tier: string) {
  const tierMap: Record<string, string> = {
    Strength: "Ù‚ÙˆØ©",
    Opportunity: "ÙØ±ØµØ©",
    Threat: "ØªÙ‡Ø¯ÙŠØ¯",
    Weakness: "Ø¶Ø¹Ù",
  };
  return tierMap[tier] || tier;
}

// Per-page capture exporter (no html2pdf pagination)
async function exportPdfByCapturingEachPage(filename: string) {
  const pages = Array.from(document.querySelectorAll<HTMLElement>(".pdfPage"));
  if (!pages.length) return;

  const [{ default: html2canvas }, { jsPDF }] = await Promise.all([
    import("html2canvas"),
    import("jspdf"),
  ]);

  const pdf = new jsPDF({
    unit: "mm",
    format: "a4",
    orientation: "portrait",
  });

  const pageW = 210;
  const pageH = 297;

  for (let i = 0; i < pages.length; i++) {
    const pageEl = pages[i];

    const canvas = await html2canvas(pageEl, {
      scale: 2,
      useCORS: true,
      backgroundColor: "#FFFFFF",
      scrollY: 0,
      windowWidth: pageEl.scrollWidth,
      windowHeight: pageEl.scrollHeight,
    });

    const imgData = canvas.toDataURL("image/jpeg", 0.98);
    const imgW = pageW;
    const imgH = (canvas.height * imgW) / canvas.width;
    const finalH = Math.min(imgH, pageH);

    if (i > 0) pdf.addPage();
    pdf.addImage(imgData, "JPEG", 0, 0, imgW, finalH);
  }

  pdf.save(filename);
}

export default function ResultsPage() {
  const [competencyResults, setCompetencyResults] = useState<CompetencyResult[]>([]);
  const [totalScore, setTotalScore] = useState(0);
  const [totalPercentage, setTotalPercentage] = useState(0);
  const [loading, setLoading] = useState(true);

  const searchParams = useSearchParams();
  const attemptId = searchParams.get("attemptId");
  const router = useRouter();
  const { language } = useLocale();
  const { user, isLoading: isSessionLoading } = useSession();

  useEffect(() => {
    if (!isSessionLoading && !user) {
      toast.info(getTranslation("loginRequired", language));
      router.push("/login");
      return;
    }

    if (!attemptId) {
      toast.error(getTranslation("quizNotFound", language));
      router.push("/");
      return;
    }

    const fetchResults = async () => {
      setLoading(true);
      try {
        const { data, error } = await supabase
          .from("quiz_attempts")
          .select("*")
          .eq("id", attemptId)
          .single();

        if (error || !data) {
          console.error("Error fetching results:", error);
          toast.error("Failed to load results");
          router.push("/");
          return;
        }

        const results = data.competency_results || [];
        setCompetencyResults(results);
        setTotalScore(data.score || 0);

        const totalMax = results.reduce(
          (sum: number, r: CompetencyResult) => sum + r.maxScore,
          0
        );
        const totalRaw = results.reduce(
          (sum: number, r: CompetencyResult) => sum + r.score,
          0
        );
        setTotalPercentage(totalMax > 0 ? Math.round((totalRaw / totalMax) * 100) : 0);
      } catch (err) {
        console.error("Unexpected error:", err);
        toast.error("An error occurred while loading results");
      } finally {
        setLoading(false);
      }
    };

    if (user && attemptId) {
      fetchResults();
    }
  }, [attemptId, user, isSessionLoading, router, language]);

  if (loading || isSessionLoading) {
    return (
      <div className="min-h-screen flex flex-col" dir={language === "ar" ? "rtl" : "ltr"}>
        <Header />
        <main className="flex-grow flex items-center justify-center p-4">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
            <p>{getTranslation("loading", language)}</p>
          </div>
        </main>
        <MadeWithDyad />
      </div>
    );
  }

  if (competencyResults.length === 0) {
    return (
      <div className="min-h-screen flex flex-col" dir={language === "ar" ? "rtl" : "ltr"}>
        <Header />
        <main className="flex-grow flex items-center justify-center p-4">
          <div className="text-center">
            <p className="text-xl mb-4">
              {language === "ar" ? "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬" : "No results found"}
            </p>
            <Button onClick={() => router.push("/")}>
              {getTranslation("backToHome", language)}
            </Button>
          </div>
        </main>
        <MadeWithDyad />
      </div>
    );
  }

  const strengths = competencyResults.filter((c) => c.tier === "Strength");
  const opportunities = competencyResults.filter((c) => c.tier === "Opportunity");
  const threats = competencyResults.filter((c) => c.tier === "Threat");
  const weaknesses = competencyResults.filter((c) => c.tier === "Weakness");

  const ordered = COMPETENCY_ORDER
    .map((id) => competencyResults.find((c) => c.competencyId === id))
    .filter(Boolean) as CompetencyResult[];

  const firstFour = ordered.slice(0, 4);
  const lastThree = ordered.slice(4);

  const today = new Date().toLocaleDateString(
    language === "ar" ? "ar-AE" : "en-AU"
  );

  const handleDownloadPDF = async () => {
    if (!attemptId) return;
    try {
      await exportPdfByCapturingEachPage(
        `Dyad-Assessment-${attemptId}-${language}.pdf`
      );
    } catch (err) {
      console.error("PDF generation error:", err);
      toast.error(
        language === "ar"
          ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
          : "Error generating PDF"
      );
    }
  };

  const renderCompBlock = (comp: CompetencyResult, index: number) => {
    const id = comp.competencyId;
    const meta = (COMPETENCY_META as any)[id];
    const label = language === "ar" ? meta.labelAr : meta.labelEn;
    const diagnostic = language === "ar" ? meta.diagnosticAr : meta.diagnosticEn;
    const tier = comp.tier;

    const bgColor =
      tier === "Strength"
        ? "bg-green-50 border-green-300"
        : tier === "Opportunity"
        ? "bg-amber-50 border-amber-300"
        : tier === "Threat"
        ? "bg-orange-50 border-orange-300"
        : "bg-red-50 border-red-300";

    const headerColor =
      tier === "Strength"
        ? "bg-green-600"
        : tier === "Opportunity"
        ? "bg-amber-500"
        : tier === "Threat"
        ? "bg-orange-500"
        : "bg-red-600";

    const barColor =
      tier === "Strength"
        ? "bg-green-500"
        : tier === "Opportunity"
        ? "bg-amber-400"
        : tier === "Threat"
        ? "bg-orange-500"
        : "bg-red-500";

    const recs = getRecommendations(id, tier, language).slice(0, 3);

    return (
      <section key={id} className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className={`${headerColor} text-white px-6 py-3`}>
          <p className="text-xs opacity-80">
            {language === "ar" ? `Ø§Ù„ÙƒÙØ§Ø¡Ø© ${index}` : `Competency ${index}`}
          </p>
          <h3 className="text-lg md:text-xl font-bold">{label}</h3>
        </div>
        <div className="p-6 space-y-4">
          <p className="text-slate-800 text-xs md:text-sm leading-relaxed">
            {diagnostic}
          </p>

          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <p className="text-xs text-slate-500 mb-1">
                {language === "ar"
                  ? "Ø¯Ø±Ø¬ØªÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙØ§Ø¡Ø©"
                  : "Your Score in this Competency"}
              </p>
              <p className="text-2xl md:text-3xl font-extrabold text-slate-900">
                {comp.percentage}%
              </p>
              <p className="text-[11px] text-slate-600">
                {comp.score} / {comp.maxScore}
              </p>
            </div>
            <div className="w-full md:w-1/2">
              <div className="w-full bg-slate-200 rounded-full h-2.5 mb-2">
                <div
                  className={`h-2.5 rounded-full ${barColor}`}
                  style={{ width: `${comp.percentage}%` }}
                />
              </div>
              <span
                className={`inline-block text-[10px] px-3 py-1 rounded-full border ${bgColor}`}
              >
                {language === "ar" ? getTierNameInArabic(tier) : tier}
              </span>
            </div>
          </div>

          <div className={`mt-2 p-4 rounded-lg border ${bgColor}`}>
            <h4 className="font-semibold mb-2 text-xs md:text-sm">
              {tier === "Strength" &&
                (language === "ar"
                  ? "ÙƒÙŠÙ ØªØ¶Ø§Ø¹Ù ØªØ£Ø«ÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ©"
                  : "How to Amplify This Strength")}
              {tier === "Opportunity" &&
                (language === "ar"
                  ? "ÙƒÙŠÙ ØªØ­ÙˆÙ‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØ±ØµØ© Ø¥Ù„Ù‰ Ù‚ÙˆØ©"
                  : "How to Turn This Opportunity into Strength")}
              {tier === "Threat" &&
                (language === "ar"
                  ? "ÙƒÙŠÙ ØªÙ‚Ù„Ù„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯ ÙˆØªØ­ÙˆÙ„Ù‡ Ø¥Ù„Ù‰ Ø²Ø®Ù…"
                  : "How to Reduce This Threat and Turn It into Momentum")}
              {tier === "Weakness" &&
                (language === "ar"
                  ? "Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ù‡ Ù†Ù‚Ø·Ø© Ø¶Ø¹Ù Ø­Ø±Ø¬Ø© â€” ÙˆÙ…Ø§ Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ù†"
                  : "Why This Is a Critical Weakness â€” and What You Can Do Now")}
            </h4>
            <ul className="list-disc pl-5 space-y-1 text-xs md:text-sm">
              {recs.map((rec, i) => (
                <li key={i}>{rec}</li>
              ))}
            </ul>
            {(tier === "Weakness" || tier === "Threat") && (
              <p className="mt-2 text-[11px] md:text-xs text-purple-700 font-semibold">
                {language === "ar"
                  ? "Ù„Ø®Ø·Ø© Ø´Ø®ØµÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¥Ù„Ù‰ Ù…Ø§ÙƒÙŠÙ†Ø© Ø¥ÙŠØ±Ø§Ø¯Ø§ØªØŒ Ù‚Ù… Ø¨Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ ÙØ­Øµ Outdoor Sales MRI Ø§Ù„ÙƒØ§Ù…Ù„."
                  : "For your full personalized strategy to turn this area into a revenue machine, upgrade to the full Outdoor Sales MRI."}
              </p>
            )}
          </div>
        </div>
      </section>
    );
  };

  return (
    <div className="min-h-screen flex flex-col" dir={language === "ar" ? "rtl" : "ltr"}>
      <Header />

      <main className="flex-grow bg-slate-900/5 py-6 md:py-10">
        {/* PDF ROOT: fixed A4 pages */}
        <div className="pdfRoot mx-auto">
          {/* PAGE 1 â€“ Cover / Intro */}
          <section className="pdfPage">
            <div className="pageHeader">
              <div className="pageTag">
                {language === "ar" ? "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…" : "Assessment Report"}
              </div>
              <div className="pageNumber">1 / 5</div>
            </div>

            <div className="cover">
              <div className="logoCircle">Dyad</div>
              <h1 className="coverTitle">
                {language === "ar"
                  ? "ÙØ­Øµ ÙƒÙØ§Ø¡Ø§Øª Ù‚ÙˆØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ù„Ø¯ÙŠÙƒ"
                  : "Your Outdoor Salesforce Competency Scan"}
              </h1>
              <p className="coverSub">
                {language === "ar"
                  ? "ØªÙ‚Ø±ÙŠØ± Ø¨ØµØ±ÙŠ Ù…Ø®ØªØµØ± ÙŠÙˆØ¶Ø­ Ø£ÙŠÙ† ØªØ±Ø¨Ø­ â€” ÙˆØ£ÙŠÙ† ØªØªØ³Ø±Ø¨ Ø§Ù„ØµÙÙ‚Ø§Øª."
                  : "A visual, executive-style report showing where you win â€” and where deals leak."}
              </p>

              <div className="infoGrid">
                <div className="infoCard">
                  <div className="infoLabel">
                    {language === "ar" ? "Ø§Ù„Ø§Ø³Ù…" : "Name"}
                  </div>
                  <div className="infoValue">
                    {user?.email ?? (language === "ar" ? "Ø¨Ø§Ø¦Ø¹ Ù…ÙŠØ¯Ø§Ù†ÙŠ" : "Field Sales Pro")}
                  </div>
                </div>
                <div className="infoCard">
                  <div className="infoLabel">Email</div>
                  <div className="infoValue">{user?.email ?? "you@example.com"}</div>
                </div>
                <div className="infoCard">
                  <div className="infoLabel">
                    {language === "ar" ? "Ø§Ù„ØªØ§Ø±ÙŠØ®" : "Date"}
                  </div>
                  <div className="infoValue">{today}</div>
                </div>
              </div>

              <div className="center">
                <div className="donutWrap">
                  <DonutChart percentage={totalPercentage} color="gradient" />
                </div>
                <div className="note">
                  {language === "ar" ? "Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„ÙƒÙ„ÙŠØ©" : "Your total score"}
                </div>
                <p className="coverHint">
                  {language === "ar"
                    ? "Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø±Ø¬Ø© ØªÙ„Ø®Øµ Ø£Ø¯Ø§Ø¡Ùƒ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ø­Ø±Ø¬Ø© Ù„Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©."
                    : "This score summarizes your performance across the seven critical pillars of outdoor sales mastery."}
                </p>
              </div>
            </div>

            <div className="pageFooter">
              {language === "ar" ? "Â© ØªÙ‚Ø±ÙŠØ± Ø®Ø§Øµ Ù…Ù† Dyad" : "Â© Private report by Dyad"}
            </div>
          </section>

          {/* PAGE 2 â€“ Donut + Bars + SWOT */}
          <section className="pdfPage">
            <div className="pageHeader">
              <div className="pageTag">
                {language === "ar" ? "Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡" : "Performance Summary"}
              </div>
              <div className="pageNumber">2 / 5</div>
            </div>

            <div className="gradTitle">
              {language === "ar" ? "Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¦Ùƒ" : "High-Level View of Your Performance"}
            </div>

            <div className="summaryGrid">
              <div className="summaryLeft">
                <h3 className="summaryTitle">
                  {language === "ar"
                    ? "Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„ÙƒÙ„ÙŠØ© ÙÙŠ Ù„Ù…Ø­Ø©"
                    : "Your Overall Score at a Glance"}
                </h3>
                <div className="summaryDonutBlock">
                  <DonutChart percentage={totalPercentage} color="gradient" />
                  <p className="summaryText">
                    {language === "ar"
                      ? "Ø¯Ù…Ø¬ Ù„ÙƒÙ„ ÙƒÙØ§Ø¡Ø§ØªÙƒ ÙÙŠ Ù…Ø¤Ø´Ø± ÙˆØ§Ø­Ø¯ ÙŠÙˆØ¶Ø­ Ù…Ø¯Ù‰ Ø¬Ø§Ù‡Ø²ÙŠØªÙƒ Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ØªÙƒ."
                      : "A single index combining all competencies that reflects how ready you are to dominate your territory."}
                  </p>
                </div>
              </div>
              <div className="summaryRight">
                <h3 className="summaryTitle">
                  {language === "ar"
                    ? "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø³Ø¨Ø¹Ø©"
                    : "Map of Your 7 Core Pillars"}
                </h3>
                <CompetencyBars results={competencyResults} language={language} />
              </div>
            </div>

            <div className="swotGrid">
              <div className="swotBox swStrength">
                <div className="swTitle">
                  {language === "ar" ? "Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©" : "Strengths"}
                </div>
                <ul className="swList">
                  {strengths.length === 0 && (
                    <li className="swItem swNone">
                      {language === "ar"
                        ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ù‚ÙˆØ© Ø­Ø§Ù„ÙŠØ§Ù‹."
                        : "No strengths identified yet."}
                    </li>
                  )}
                  {strengths.map((c) => {
                    const meta = (COMPETENCY_META as any)[c.competencyId];
                    const label = language === "ar" ? meta.labelAr : meta.labelEn;
                    return (
                      <li key={c.competencyId} className="swItem swTextStrength">
                        â€¢ {label} ({c.percentage}%)
                      </li>
                    );
                  })}
                </ul>
              </div>

              <div className="swotBox swOpp">
                <div className="swTitle">
                  {language === "ar" ? "Ø§Ù„ÙØ±Øµ" : "Opportunities"}
                </div>
                <ul className="swList">
                  {opportunities.length === 0 && (
                    <li className="swItem swNone">
                      {language === "ar"
                        ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Øµ Ø­Ø§Ù„ÙŠØ§Ù‹."
                        : "No major opportunities identified yet."}
                    </li>
                  )}
                  {opportunities.map((c) => {
                    const meta = (COMPETENCY_META as any)[c.competencyId];
                    const label = language === "ar" ? meta.labelAr : meta.labelEn;
                    return (
                      <li key={c.competencyId} className="swItem swTextOpp">
                        â€¢ {label} ({c.percentage}%)
                      </li>
                    );
                  })}
                </ul>
              </div>

              <div className="swotBox swThreat">
                <div className="swTitle">
                  {language === "ar" ? "Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯Ø§Øª" : "Threats"}
                </div>
                <ul className="swList">
                  {threats.length === 0 && (
                    <li className="swItem swNone">
                      {language === "ar"
                        ? "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‡Ø¯ÙŠØ¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹."
                        : "No threats identified yet."}
                    </li>
                  )}
                  {threats.map((c) => {
                    const meta = (COMPETENCY_META as any)[c.competencyId];
                    const label = language === "ar" ? meta.labelAr : meta.labelEn;
                    return (
                      <li key={c.competencyId} className="swItem swTextThreat">
                        â€¢ {label} ({c.percentage}%)
                      </li>
                    );
                  })}
                </ul>
              </div>

              <div className="swotBox swWeak">
                <div className="swTitle">
                  {language === "ar" ? "Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù" : "Weaknesses"}
                </div>
                <ul className="swList">
                  {weaknesses.length === 0 && (
                    <li className="swItem swNone">
                      {language === "ar"
                        ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ø­Ø§Ù„ÙŠØ§Ù‹."
                        : "No weaknesses identified yet."}
                    </li>
                  )}
                  {weaknesses.map((c) => {
                    const meta = (COMPETENCY_META as any)[c.competencyId];
                    const label = language === "ar" ? meta.labelAr : meta.labelEn;
                    return (
                      <li key={c.competencyId} className="swItem swTextWeak">
                        â€¢ {label} ({c.percentage}%)
                      </li>
                    );
                  })}
                </ul>
              </div>
            </div>

            <div className="pageFooter">
              {language === "ar" ? "ØµÙØ­Ø© 2" : "Page 2"}
            </div>
          </section>

          {/* PAGE 3 â€“ First 4 competencies */}
          <section className="pdfPage">
            <div className="pageHeader">
              <div className="pageTag">
                {language === "ar" ? "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒÙØ§Ø¡Ø§Øª (1â€“4)" : "Competency Details (1â€“4)"}
              </div>
              <div className="pageNumber">3 / 5</div>
            </div>

            <div className="pageBodyScrollable">
              {firstFour.map((comp, idx) => renderCompBlock(comp, idx + 1))}
            </div>

            <div className="pageFooter">
              {language === "ar" ? "ØµÙØ­Ø© 3" : "Page 3"}
            </div>
          </section>

          {/* PAGE 4 â€“ Last 3 competencies */}
          <section className="pdfPage">
            <div className="pageHeader">
              <div className="pageTag">
                {language === "ar" ? "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒÙØ§Ø¡Ø§Øª (5â€“7)" : "Competency Details (5â€“7)"}
              </div>
              <div className="pageNumber">4 / 5</div>
            </div>

            <div className="pageBodyScrollable">
              {lastThree.map((comp, idx) =>
                renderCompBlock(comp, firstFour.length + idx + 1)
              )}
            </div>

            <div className="pageFooter">
              {language === "ar" ? "ØµÙØ­Ø© 4" : "Page 4"}
            </div>
          </section>

          {/* PAGE 5 â€“ Explosive Sales Page */}
          <section className="pdfPage">
            <div className="pageHeader">
              <div className="pageTag">
                {language === "ar" ? "Ø®Ø·ÙˆØªÙƒ Ø§Ù„ØªØ§Ù„ÙŠØ©" : "Your Next Step"}
              </div>
              <div className="pageNumber">5 / 5</div>
            </div>

            <div className="salesPage">
              <h2 className="salesTitle">
                {language === "ar"
                  ? "ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù‚Ø¯ ÙŠÙƒÙ„ÙÙƒ Ø¹Ø´Ø±Ø§Øª Ø§Ù„Ø¢Ù„Ø§Ù Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ù€ 12 Ø´Ù‡Ø±Ø§Ù‹ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©"
                  : "Warning: Staying at This Level Could Cost You Hundreds of Thousands in Lost Commissions Over the Next 12 Months"}
              </h2>

              <p className="salesLead">
                {language === "ar"
                  ? "Ù‚Ù… Ø¨Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ ÙØ­Øµ Outdoor Selling Skills MRI Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù…Ø¶Ø§Ø¹ÙØ© Ù…Ø¨ÙŠØ¹Ø§ØªÙƒ ÙÙŠ Ø³ÙˆÙ‚ Ù‚Ø§Ø³Ù ÙˆÙ…Ù†Ø§ÙØ³."
                  : "Upgrade NOW to the Full Outdoor Selling Skills MRI and get the complete blueprint to double your sales in a brutally competitive market."}
              </p>

              <div className="salesGrid">
                <div className="space-y-3">
                  <h3 className="salesSubTitle">
                    {language === "ar"
                      ? "Ù…Ø§Ø°Ø§ Ø³ØªØ­ØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…"
                      : "What You Get When You Upgrade Today"}
                  </h3>
                  <ul className="salesList">
                    <li>
                      {language === "ar"
                        ? "ÙƒØ´Ù Ø£Ø¯Ø§Ø¦Ùƒ Ø¹Ø¨Ø± 12 ÙƒÙØ§Ø¡Ø© Ø¹Ù…ÙŠÙ‚Ø© Ù…Ø¹ 75 Ø³Ø¤Ø§Ù„ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù…ØªÙ‚Ø¯Ù…."
                        : "Uncover your performance across 12 deep competencies with 75 advanced scenario questions."}
                    </li>
                    <li>
                      {language === "ar"
                        ? "Ø§Ø³ØªÙ„Ù… ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ ØªØ´Ø®ÙŠØµÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù…Ù† 25 ØµÙØ­Ø© Ù…Ø¹ ØªÙ‚Ø³ÙŠÙ… Ù…ØªÙ‚Ø¯Ù… Ù„Ø£Ø±Ø¨Ø¹ Ø·Ø¨Ù‚Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„ SWOT Ø¹Ù…ÙŠÙ‚."
                        : "Receive a 25-page comprehensive diagnostic report with advanced 4-band scoring and deep SWOT analysis."}
                    </li>
                    <li>
                      {language === "ar"
                        ? "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ§Øª Ø´Ø®ØµÙŠØ© Ù„ÙƒÙ„ ÙƒÙØ§Ø¡Ø© â€” Ø¨Ø¯ÙˆÙ† Ù†ØµØ§Ø¦Ø­ Ø¹Ø§Ù…Ø©."
                        : "Get personalized recommendations for every competency â€“ no generic advice."}
                    </li>
                    <li>
                      {language === "ar"
                        ? "Ø§Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ø®Ø·Ø© Ø¹Ù…Ù„ Ù…Ø®ØµØµØ© Ù„Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø± ØªØ­ÙˆÙ„ Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙÙƒ Ø¥Ù„Ù‰ Ù…ØµØ§Ù†Ø¹ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª."
                        : "Access your custom 3-month action plan designed to systematically turn weaknesses into revenue machines."}
                    </li>
                    <li>
                      {language === "ar"
                        ? "Ø£ØºÙ„Ù‚ ÙØ¬ÙˆØ© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ø¹ Ù…Ø­ØªØ±ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†."
                        : "Lock in elite-level field sales mastery and predictable quota-crushing results."}
                    </li>
                  </ul>
                </div>
                <div className="space-y-3">
                  <h3 className="salesSubTitle">
                    {language === "ar"
                      ? "Ù…Ø§Ø°Ø§ ØªÙƒØ³Ø¨ Ù…Ù‚Ø§Ø¨Ù„ Ù…Ø§ Ù‚Ø¯ ØªØ®Ø³Ø±Ù‡"
                      : "What You Gain vs. What You Lose"}
                  </h3>
                  <p className="salesBody">
                    {language === "ar"
                      ? "Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: ØªØ¶Ø§Ø¹Ù Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ØŒ ØªØ³ÙŠØ·Ø± Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ØªÙƒØŒ ØªØ­Ù‚Ù‚ Ù‚ÙØ²Ø© ÙÙŠ Ø¯Ø®Ù„ÙƒØŒ ÙˆØªØµØ¨Ø­ Ù…Ø±Ø¬Ø¹Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©."
                      : "If You Upgrade Today: Double your closing rate, dominate your territory, achieve financial freedom, and become the go-to authority in outdoor sales."}
                  </p>
                  <p className="salesBody">
                    {language === "ar"
                      ? "Ø¥Ø°Ø§ ØªØ¬Ø§Ù‡Ù„Øª Ø§Ù„Ø®Ø·ÙˆØ©: ØªØ³ØªÙ…Ø± ÙÙŠ ØªØ±Ùƒ 30â€“70% Ù…Ù† Ø§Ù„ØµÙÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©ØŒ ØªØ¹Ø§Ù†ÙŠ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ°Ø¨Ø°Ø¨Ø©ØŒ ÙˆØªØ´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ† ÙŠØªÙ‚Ø¯Ù…ÙˆÙ†."
                      : "If You Walk Away: Continue leaving 30â€“70% of possible deals on the table, burn out from inconsistent results, watch competitors pull ahead, and miss the next promotion or income jump."}
                  </p>
                </div>
              </div>

              <p className="salesBody">
                {language === "ar"
                  ? "Ù‡Ø°Ø§ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ø£Ø¸Ù‡Ø± Ù„Ùƒ ÙÙ‚Ø· Ù‚Ù…Ø© Ø§Ù„Ø¬Ø¨Ù„ Ø§Ù„Ø¬Ù„ÙŠØ¯ÙŠ. ÙØ­Øµ MRI Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠÙƒØ´Ù ÙƒÙ„ ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ù„ÙŠØ¯ Ø§Ù„ØªÙŠ ØªÙ‚ØªÙ„ Ø¥ÙŠØ±Ø§Ø¯Ø§ØªÙƒ â€” ÙˆÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„ØªØ­Ø·ÙŠÙ…Ù‡Ø§."
                  : "This free scan showed you the tip of the iceberg. The Full MRI reveals the entire revenue-killing iceberg â€” and exactly how to destroy it."}
              </p>

              <div className="salesCtaWrapper">
                <div className="salesCtaBox">
                  {language === "ar"
                    ? "Ù†Ø¹Ù… â€” Ø£Ø±ÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¥Ù„Ù‰ ÙØ­Øµ Outdoor Selling Skills MRI Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¢Ù†"
                    : "YES â€“ Give Me Instant Access to the Full Outdoor Selling Skills MRI Now"}
                  <div className="salesUrl">
                    [Insert_Your_Sales_Page_URL_Here]
                  </div>
                </div>
                <p className="salesScarcity">
                  {language === "ar"
                    ? "Ø£Ù…Ø§ÙƒÙ† Ù…Ø­Ø¯ÙˆØ¯Ø© â€” Ø§Ø­Ø¬Ø² ÙØ­ØµÙƒ Ù‚Ø¨Ù„ Ø£Ù† ØªÙØºÙ„Ù‚."
                    : "Limited spots available â€“ claim your MRI before they're gone."}
                </p>
              </div>
            </div>

            <div className="pageFooter">
              {language === "ar" ? "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±" : "End of report"}
            </div>
          </section>
        </div>

        {/* Controls outside PDF capture */}
        <div className="flex flex-col items-center gap-4 mt-8">
          <button
            onClick={handleDownloadPDF}
            className="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 flex items-center gap-2 shadow-lg"
          >
            ğŸ“¥ {language === "ar" ? "ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF)" : "Download Report (PDF)"}
          </button>

          <Button onClick={() => router.push("/")} variant="outline">
            {getTranslation("backToHome", language)}
          </Button>
        </div>
      </main>

      <MadeWithDyad />

      {/* PDF-specific global styles */}
      <style jsx global>{`
        .pdfRoot {
          background: radial-gradient(circle at top left, #e0f2fe 0, #f9fafb 45%, #fef2f2 100%);
          padding: 16px;
          border-radius: 18px;
          max-width: 210mm;
        }

        .pdfPage {
          width: 210mm;
          height: 297mm;
          padding: 14mm;
          box-sizing: border-box;
          background: #ffffff;
          position: relative;
          overflow: hidden;
          margin: 0 auto 10px auto;
          border-radius: 12px;
          box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
        }

        .pageHeader {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 11px;
          font-weight: 800;
          color: #0f172a;
          margin-bottom: 6mm;
        }

        .pageTag {
          padding: 4px 10px;
          border-radius: 999px;
          background: rgba(37, 99, 235, 0.08);
          color: #1d4ed8;
          border: 1px solid rgba(129, 140, 248, 0.35);
        }

        .pageNumber {
          color: #64748b;
          font-weight: 700;
        }

        .pageFooter {
          position: absolute;
          left: 14mm;
          right: 14mm;
          bottom: 8mm;
          text-align: center;
          font-size: 11px;
          color: #64748b;
          font-weight: 700;
        }

        .cover {
          text-align: center;
          margin-top: 10mm;
        }

        .logoCircle {
          width: 72px;
          height: 72px;
          border-radius: 999px;
          background: linear-gradient(to right, #3b82f6, #a855f7, #ec4899);
          display: grid;
          place-items: center;
          color: white;
          font-weight: 900;
          margin: 0 auto 16px auto;
          box-shadow: 0 10px 25px rgba(59, 130, 246, 0.45);
        }

        .coverTitle {
          font-size: 26px;
          line-height: 1.15;
          margin: 0;
          font-weight: 950;
          color: #0f172a;
        }

        .coverSub {
          font-size: 13px;
          color: #475569;
          margin: 10px auto 16px auto;
          max-width: 160mm;
          line-height: 1.6;
        }

        .coverHint {
          font-size: 11px;
          color: #6b7280;
          max-width: 130mm;
          margin: 4px auto 0 auto;
        }

        .infoGrid {
          display: grid;
          grid-template-columns: repeat(3, minmax(0, 1fr));
          gap: 10px;
          margin: 14px auto 10mm auto;
          max-width: 160mm;
        }

        .infoCard {
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: 8px 10px;
          background: #f9fafb;
        }

        .infoLabel {
          font-size: 11px;
          color: #64748b;
          font-weight: 800;
          margin-bottom: 3px;
        }

        .infoValue {
          font-size: 12px;
          color: #0f172a;
          font-weight: 900;
          word-break: break-all;
        }

        .center {
          display: grid;
          place-items: center;
          gap: 6px;
          margin-top: 8mm;
        }

        .donutWrap {
          margin-bottom: 4px;
        }

        .note {
          font-weight: 900;
          color: #0f172a;
          font-size: 12px;
        }

        .gradTitle {
          width: 100%;
          border-radius: 12px;
          padding: 10px 12px;
          color: white;
          font-weight: 950;
          font-size: 15px;
          background: linear-gradient(to right, #3b82f6, #6366f1, #ec4899);
          margin-bottom: 8mm;
          text-align: center;
        }

        .summaryGrid {
          display: grid;
          grid-template-columns: 1.1fr 1.1fr;
          gap: 10mm;
          margin-bottom: 8mm;
        }

        .summaryTitle {
          font-size: 13px;
          font-weight: 900;
          color: #0f172a;
          margin-bottom: 6px;
        }

        .summaryDonutBlock {
          border-radius: 14px;
          border: 1px solid #e5e7eb;
          padding: 10px;
          background: #f9fafb;
          display: grid;
          place-items: center;
          gap: 8px;
        }

        .summaryText {
          font-size: 11px;
          color: #4b5563;
          line-height: 1.5;
          text-align: center;
        }

        .swotGrid {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 10px;
        }

        .swotBox {
          border-radius: 12px;
          padding: 8px 10px;
          border-width: 1px;
          border-style: solid;
          background: #ffffff;
        }

        .swStrength {
          border-color: #bbf7d0;
          background: #f0fdf4;
        }
        .swOpp {
          border-color: #bfdbfe;
          background: #eff6ff;
        }
        .swThreat {
          border-color: #fed7aa;
          background: #fff7ed;
        }
        .swWeak {
          border-color: #fecaca;
          background: #fef2f2;
        }

        .swTitle {
          font-size: 12px;
          font-weight: 900;
          margin-bottom: 4px;
        }

        .swList {
          list-style: none;
          margin: 0;
          padding: 0;
          display: grid;
          gap: 3px;
          font-size: 11px;
        }

        .swItem {
          line-height: 1.4;
        }

        .swNone {
          color: #6b7280;
        }

        .swTextStrength {
          color: #166534;
        }
        .swTextOpp {
          color: #1d4ed8;
        }
        .swTextThreat {
          color: #9a3412;
        }
        .swTextWeak {
          color: #991b1b;
        }

        .pageBodyScrollable {
          max-height: 240mm;
          overflow: hidden;
        }

        .salesPage {
          color: white;
          background: radial-gradient(circle at top left, rgba(254, 249, 195, 0.15), transparent 55%),
            linear-gradient(to bottom right, #f97316, #dc2626, #7f1d1d);
          border-radius: 16px;
          padding: 12mm;
          display: flex;
          flex-direction: column;
          gap: 8px;
          box-sizing: border-box;
        }

        .salesTitle {
          font-size: 18px;
          font-weight: 900;
          line-height: 1.4;
          margin: 0 0 6px 0;
        }

        .salesLead {
          font-size: 13px;
          font-weight: 700;
          margin-bottom: 6px;
        }

        .salesGrid {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 10px;
          margin: 4px 0 6px 0;
        }

        .salesSubTitle {
          font-size: 12px;
          font-weight: 800;
          color: #fef9c3;
        }

        .salesList {
          list-style: none;
          padding-left: 0;
          font-size: 11px;
          display: grid;
          gap: 4px;
        }

        .salesList li::before {
          content: "â€¢ ";
        }

        .salesBody {
          font-size: 11px;
          line-height: 1.5;
        }

        .salesCtaWrapper {
          margin-top: 6px;
        }

        .salesCtaBox {
          background: white;
          color: #7f1d1d;
          font-weight: 900;
          text-align: center;
          padding: 10px 12px;
          border-radius: 12px;
          font-size: 11px;
          box-shadow: 0 10px 25px rgba(127, 29, 29, 0.35);
        }

        .salesUrl {
          margin-top: 4px;
          font-size: 10px;
          color: #374151;
          word-break: break-all;
        }

        .salesScarcity {
          margin-top: 4px;
          font-size: 10px;
          color: #fef9c3;
          font-style: italic;
        }

        @media print {
          .pdfRoot {
            box-shadow: none;
            background: #ffffff;
            padding: 0;
          }
          .pdfPage {
            box-shadow: none;
            margin: 0;
          }
        }
      `}</style>
    </div>
  );
}
